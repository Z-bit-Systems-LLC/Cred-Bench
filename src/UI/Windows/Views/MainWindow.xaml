<ui:FluentWindow
    x:Class="CredBench.Windows.Views.MainWindow"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:ui="http://schemas.lepo.co/wpfui/2022/xaml"
    xmlns:converters="clr-namespace:CredBench.Windows.Converters"
    xmlns:viewmodels="clr-namespace:CredBench.Core.ViewModels;assembly=Core"
    mc:Ignorable="d"
    Title="Cred Bench"
    Width="800"
    SizeToContent="Height"
    MinWidth="700"
    WindowStartupLocation="CenterScreen"
    ResizeMode="CanMinimize"
    ExtendsContentIntoTitleBar="True"
    d:DataContext="{d:DesignInstance viewmodels:MainViewModel}">

    <ui:FluentWindow.Resources>
        <converters:BooleanToVisibilityConverter x:Key="BoolToVisibility" />
        <converters:TechnologyToColorConverter x:Key="TechToColor" />

        <!-- Scanning glow animation storyboard -->
        <Storyboard x:Key="ScanningGlowAnimation" RepeatBehavior="Forever">
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.Effect).(DropShadowEffect.Opacity)"
                From="0.4"
                To="1.0"
                Duration="0:0:0.35"
                AutoReverse="True" />
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.Effect).(DropShadowEffect.BlurRadius)"
                From="15"
                To="30"
                Duration="0:0:0.35"
                AutoReverse="True" />
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleX)"
                From="1.0"
                To="1.08"
                Duration="0:0:0.35"
                AutoReverse="True" />
            <DoubleAnimation
                Storyboard.TargetProperty="(UIElement.RenderTransform).(ScaleTransform.ScaleY)"
                From="1.0"
                To="1.08"
                Duration="0:0:0.35"
                AutoReverse="True" />
        </Storyboard>

        <!-- Base style for technology badges -->
        <Style x:Key="TechBadgeBaseStyle" TargetType="Border">
            <Setter Property="CornerRadius" Value="4" />
            <Setter Property="Padding" Value="12,6" />
            <Setter Property="Margin" Value="0,0,8,8" />
            <Setter Property="RenderTransformOrigin" Value="0.5,0.5" />
            <Setter Property="RenderTransform">
                <Setter.Value>
                    <ScaleTransform ScaleX="1" ScaleY="1" />
                </Setter.Value>
            </Setter>
            <Setter Property="Effect">
                <Setter.Value>
                    <DropShadowEffect
                        Color="#3B82F6"
                        ShadowDepth="0"
                        BlurRadius="15"
                        Opacity="0" />
                </Setter.Value>
            </Setter>
        </Style>

        <!-- Individual technology badge styles -->
        <Style x:Key="PIVBadgeStyle" TargetType="Border" BasedOn="{StaticResource TechBadgeBaseStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsScanningPIV}" Value="True">
                    <DataTrigger.EnterActions>
                        <BeginStoryboard x:Name="GlowStoryboard" Storyboard="{StaticResource ScanningGlowAnimation}" />
                    </DataTrigger.EnterActions>
                    <DataTrigger.ExitActions>
                        <StopStoryboard BeginStoryboardName="GlowStoryboard" />
                    </DataTrigger.ExitActions>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="DESFireBadgeStyle" TargetType="Border" BasedOn="{StaticResource TechBadgeBaseStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsScanningDESFire}" Value="True">
                    <DataTrigger.EnterActions>
                        <BeginStoryboard x:Name="GlowStoryboard" Storyboard="{StaticResource ScanningGlowAnimation}" />
                    </DataTrigger.EnterActions>
                    <DataTrigger.ExitActions>
                        <StopStoryboard BeginStoryboardName="GlowStoryboard" />
                    </DataTrigger.ExitActions>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="ISO14443BadgeStyle" TargetType="Border" BasedOn="{StaticResource TechBadgeBaseStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsScanningISO14443}" Value="True">
                    <DataTrigger.EnterActions>
                        <BeginStoryboard x:Name="GlowStoryboard" Storyboard="{StaticResource ScanningGlowAnimation}" />
                    </DataTrigger.EnterActions>
                    <DataTrigger.ExitActions>
                        <StopStoryboard BeginStoryboardName="GlowStoryboard" />
                    </DataTrigger.ExitActions>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="PKOCBadgeStyle" TargetType="Border" BasedOn="{StaticResource TechBadgeBaseStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsScanningPKOC}" Value="True">
                    <DataTrigger.EnterActions>
                        <BeginStoryboard x:Name="GlowStoryboard" Storyboard="{StaticResource ScanningGlowAnimation}" />
                    </DataTrigger.EnterActions>
                    <DataTrigger.ExitActions>
                        <StopStoryboard BeginStoryboardName="GlowStoryboard" />
                    </DataTrigger.ExitActions>
                </DataTrigger>
            </Style.Triggers>
        </Style>

        <Style x:Key="LEAFBadgeStyle" TargetType="Border" BasedOn="{StaticResource TechBadgeBaseStyle}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding IsScanningLEAF}" Value="True">
                    <DataTrigger.EnterActions>
                        <BeginStoryboard x:Name="GlowStoryboard" Storyboard="{StaticResource ScanningGlowAnimation}" />
                    </DataTrigger.EnterActions>
                    <DataTrigger.ExitActions>
                        <StopStoryboard BeginStoryboardName="GlowStoryboard" />
                    </DataTrigger.ExitActions>
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </ui:FluentWindow.Resources>

    <Grid>
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto" />
            <RowDefinition Height="*" />
        </Grid.RowDefinitions>

        <!-- Title Bar -->
        <ui:TitleBar
            Grid.Row="0"
            Title="Cred-Bench"
            ShowMaximize="True"
            ShowMinimize="True" />

        <!-- Main Content -->
        <StackPanel Grid.Row="1" Margin="24">
                <!-- Reader Selection -->
                <ui:Card Margin="0,0,0,16">
                    <Grid>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="*" />
                            <ColumnDefinition Width="Auto" />
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock
                                Text="Reader"
                                FontWeight="SemiBold"
                                Margin="0,0,0,8" />
                            <ComboBox
                                ItemsSource="{Binding AvailableReaders}"
                                SelectedItem="{Binding SelectedReader}"
                                IsEnabled="{Binding IsScanning, Converter={StaticResource BoolToVisibility}, ConverterParameter=Invert}"
                                MinWidth="250" />
                        </StackPanel>

                        <StackPanel Grid.Column="1" Orientation="Horizontal" VerticalAlignment="Bottom">
                            <ui:Button
                                Icon="{ui:SymbolIcon ArrowSync24}"
                                Command="{Binding RefreshReadersCommand}"
                                ToolTip="Refresh readers"
                                Margin="12,0,0,0" />
                            <ui:Button
                                Icon="{ui:SymbolIcon ArrowReset24}"
                                Command="{Binding ResetReaderCommand}"
                                ToolTip="Reset reader (use when reader stops responding)"
                                Margin="4,0,0,0" />
                        </StackPanel>
                    </Grid>
                </ui:Card>

                <!-- Two Column Layout: Card Status (Left) and Details (Right) -->
                <Grid Margin="0,0,0,16">
                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" />
                        <ColumnDefinition Width="*" />
                    </Grid.ColumnDefinitions>

                    <!-- Left Column: Card Status and Technologies -->
                    <StackPanel Grid.Column="0" Margin="0,0,16,0">
                        <!-- Card Status Area -->
                        <ui:Card Margin="0,0,0,16" MinWidth="200" Height="280">
                            <StackPanel Margin="24,24,24,16" VerticalAlignment="Center">
                                <Grid HorizontalAlignment="Center" MinHeight="160">
                                    <!-- Idle State: Present Card to Reader -->
                                    <StackPanel
                                        Visibility="{Binding IsScanning, Converter={StaticResource BoolToVisibility}, ConverterParameter=Invert}">
                                        <ui:SymbolIcon
                                            Symbol="ContactCardGeneric24"
                                            FontSize="64"
                                            Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                        <TextBlock
                                            Text="Present Card to Reader"
                                            HorizontalAlignment="Center"
                                            Margin="0,16,0,0"
                                            FontSize="16"
                                            Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                        <ui:Button
                                            Content="Scan Card"
                                            Icon="{ui:SymbolIcon ScanDash24}"
                                            Command="{Binding ScanCardCommand}"
                                            HorizontalAlignment="Center"
                                            Margin="0,16,0,0"
                                            Appearance="Primary" />
                                    </StackPanel>

                                    <!-- Scanning State: Card Being Scanned Animation -->
                                    <StackPanel
                                        x:Name="ScanningPanel"
                                        Visibility="{Binding IsScanning, Converter={StaticResource BoolToVisibility}}">
                                        <StackPanel.Triggers>
                                            <EventTrigger RoutedEvent="FrameworkElement.Loaded">
                                                <BeginStoryboard>
                                                    <Storyboard RepeatBehavior="Forever">
                                                        <!-- Scan line moving down the card -->
                                                        <DoubleAnimation
                                                            Storyboard.TargetName="ScanLine"
                                                            Storyboard.TargetProperty="(Canvas.Top)"
                                                            From="10"
                                                            To="58"
                                                            Duration="0:0:1.2"
                                                            AutoReverse="True" />
                                                    </Storyboard>
                                                </BeginStoryboard>
                                            </EventTrigger>
                                        </StackPanel.Triggers>

                                        <Canvas Width="100" Height="70" HorizontalAlignment="Center">
                                            <!-- Card Shape -->
                                            <Border Canvas.Left="10" Canvas.Top="8"
                                                    Width="80" Height="54"
                                                    Background="{DynamicResource ControlFillColorDefaultBrush}"
                                                    BorderBrush="{DynamicResource AccentTextFillColorPrimaryBrush}"
                                                    BorderThickness="2"
                                                    CornerRadius="6">
                                                <Grid>
                                                    <!-- Chip on card -->
                                                    <Border
                                                        Width="16" Height="12"
                                                        Background="{DynamicResource AccentFillColorDefaultBrush}"
                                                        CornerRadius="2"
                                                        HorizontalAlignment="Left"
                                                        VerticalAlignment="Top"
                                                        Margin="8,10,0,0" />
                                                    <!-- Magnetic stripe line -->
                                                    <Rectangle
                                                        Width="50" Height="4"
                                                        Fill="{DynamicResource TextFillColorSecondaryBrush}"
                                                        HorizontalAlignment="Right"
                                                        VerticalAlignment="Bottom"
                                                        Margin="0,0,8,10"
                                                        RadiusX="2" RadiusY="2" />
                                                </Grid>
                                            </Border>

                                            <!-- Scanning Line -->
                                            <Rectangle x:Name="ScanLine"
                                                       Canvas.Left="12" Canvas.Top="10"
                                                       Width="76" Height="3"
                                                       RadiusX="1.5" RadiusY="1.5">
                                                <Rectangle.Fill>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,0">
                                                        <GradientStop Color="Transparent" Offset="0" />
                                                        <GradientStop Color="#60FFFFFF" Offset="0.3" />
                                                        <GradientStop Color="#FFFFFFFF" Offset="0.5" />
                                                        <GradientStop Color="#60FFFFFF" Offset="0.7" />
                                                        <GradientStop Color="Transparent" Offset="1" />
                                                    </LinearGradientBrush>
                                                </Rectangle.Fill>
                                            </Rectangle>
                                        </Canvas>

                                        <TextBlock
                                            Text="Scanning Card..."
                                            HorizontalAlignment="Center"
                                            Margin="0,12,0,0"
                                            FontSize="16"
                                            FontWeight="Medium"
                                            Foreground="{DynamicResource AccentTextFillColorPrimaryBrush}" />
                                    </StackPanel>
                                </Grid>

                                <!-- Status Message -->
                                <TextBlock
                                    Text="{Binding StatusMessage}"
                                    HorizontalAlignment="Center"
                                    Margin="0,16,0,0"
                                    TextWrapping="Wrap"
                                    TextAlignment="Center"
                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                            </StackPanel>
                        </ui:Card>

                        <!-- Detected Technologies -->
                        <ui:Card>
                            <StackPanel>
                                <TextBlock
                                    Text="Detected Technologies"
                                    FontWeight="SemiBold"
                                    Margin="0,0,0,12" />
                                <WrapPanel>
                                    <Border
                                        Style="{StaticResource PIVBadgeStyle}"
                                        Background="{Binding HasPIV, Converter={StaticResource TechToColor}}">
                                        <TextBlock Text="PIV" Foreground="White" FontWeight="Medium" />
                                    </Border>
                                    <Border
                                        Style="{StaticResource DESFireBadgeStyle}"
                                        Background="{Binding HasDESFire, Converter={StaticResource TechToColor}}">
                                        <TextBlock Text="DESFire" Foreground="White" FontWeight="Medium" />
                                    </Border>
                                    <Border
                                        Style="{StaticResource ISO14443BadgeStyle}"
                                        Background="{Binding HasISO14443, Converter={StaticResource TechToColor}}">
                                        <TextBlock Text="ISO14443" Foreground="White" FontWeight="Medium" />
                                    </Border>
                                    <Border
                                        Style="{StaticResource PKOCBadgeStyle}"
                                        Background="{Binding HasPKOC, Converter={StaticResource TechToColor}}">
                                        <TextBlock Text="PKOC" Foreground="White" FontWeight="Medium" />
                                    </Border>
                                    <Border
                                        Style="{StaticResource LEAFBadgeStyle}"
                                        Background="{Binding HasLEAF, Converter={StaticResource TechToColor}}">
                                        <TextBlock Text="LEAF" Foreground="White" FontWeight="Medium" />
                                    </Border>
                                </WrapPanel>
                            </StackPanel>
                        </ui:Card>
                    </StackPanel>

                    <!-- Right Column: Card Details -->
                    <ui:Card Grid.Column="1" VerticalAlignment="Top">
                        <StackPanel>
                            <TextBlock
                                Text="Card Details"
                                FontWeight="SemiBold"
                                Margin="0,0,0,12" />

                            <!-- Placeholder when no card scanned -->
                            <TextBlock
                                Text="No card scanned yet"
                                Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                Visibility="{Binding CurrentResult, Converter={StaticResource BoolToVisibility}, ConverterParameter=Invert}" />

                            <!-- Card details when available -->
                            <StackPanel Visibility="{Binding CurrentResult, Converter={StaticResource BoolToVisibility}}">
                                <Grid>
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="80" />
                                        <ColumnDefinition Width="*" />
                                    </Grid.ColumnDefinitions>
                                    <Grid.RowDefinitions>
                                        <RowDefinition Height="Auto" />
                                        <RowDefinition Height="Auto" />
                                    </Grid.RowDefinitions>

                                    <TextBlock
                                        Grid.Row="0"
                                        Grid.Column="0"
                                        Text="ATR:"
                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                        Margin="0,0,0,4" />
                                    <TextBlock
                                        Grid.Row="0"
                                        Grid.Column="1"
                                        Text="{Binding CurrentResult.ATR, FallbackValue='N/A'}"
                                        TextWrapping="Wrap"
                                        FontFamily="Consolas"
                                        Margin="0,0,0,4" />

                                    <TextBlock
                                        Grid.Row="1"
                                        Grid.Column="0"
                                        Text="UID:"
                                        Foreground="{DynamicResource TextFillColorSecondaryBrush}"
                                        Margin="0,0,0,4" />
                                    <TextBlock
                                        Grid.Row="1"
                                        Grid.Column="1"
                                        Text="{Binding CurrentResult.UID, FallbackValue='N/A'}"
                                        FontFamily="Consolas"
                                        Margin="0,0,0,4" />
                                </Grid>

                                <!-- Technology-specific details -->
                                <ItemsControl
                                    ItemsSource="{Binding CurrentResult.Details}"
                                    Margin="0,8,0,0">
                                    <ItemsControl.ItemTemplate>
                                        <DataTemplate>
                                            <StackPanel Margin="0,4,0,0">
                                                <TextBlock
                                                    Text="{Binding Key}"
                                                    FontWeight="Medium"
                                                    Foreground="{DynamicResource TextFillColorSecondaryBrush}" />
                                                <TextBlock
                                                    Text="{Binding Value}"
                                                    FontFamily="Consolas"
                                                    TextWrapping="Wrap"
                                                    Margin="0,2,0,0" />
                                            </StackPanel>
                                        </DataTemplate>
                                    </ItemsControl.ItemTemplate>
                                </ItemsControl>
                            </StackPanel>
                        </StackPanel>
                    </ui:Card>
                </Grid>
            </StackPanel>
    </Grid>
</ui:FluentWindow>
